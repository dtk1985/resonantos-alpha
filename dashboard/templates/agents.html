{% extends "base.html" %}

{% block title %}Agents - ResonantOS Dashboard{% endblock %}
{% block page_title %}Agents{% endblock %}

{% block content %}
<!-- Orchestrator + Memory (side by side) -->
<div id="orchestratorRow" style="display:flex; align-items:flex-start; justify-content:center; gap:20px; flex-wrap:wrap;">
    <div id="orchestratorSection"></div>
    <div id="memoryAgentSection" style="display:none; align-self:center;"></div>
</div>

<!-- Connection Lines -->
<div id="connectorLine" style="display:none; text-align:center; padding:4px 0;">
    <svg width="100%" height="40" style="max-width:800px;">
        <line x1="50%" y1="0" x2="50%" y2="20" stroke="var(--border-light)" stroke-width="2"/>
        <line x1="10%" y1="20" x2="90%" y2="20" stroke="var(--border-light)" stroke-width="2"/>
    </svg>
</div>

<!-- Category Sections -->
<div id="directAgents"></div>
<div id="backgroundAgents" style="margin-top:24px;"></div>
<div id="supportAgents" style="margin-top:24px;"></div>

<!-- Agent Detail Modal -->
<div class="modal" id="agentModal">
    <div class="modal-content modal-wide">
        <div class="modal-header">
            <h2 class="modal-title" id="modalTitle">Agent Details</h2>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body" id="modalBody"></div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Orchestrator card */
.orchestrator-card {
    background: var(--bg-secondary);
    border: 2px solid var(--success);
    border-radius: var(--radius);
    padding: 24px 32px;
    max-width: 520px;
    margin: 0 auto 8px auto;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}
.orchestrator-card:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(74,222,128,0.15); }
.orchestrator-card::after {
    content: 'ORCHESTRATOR';
    position: absolute; top: 8px; right: 12px;
    font-size: 9px; letter-spacing: 1.5px; color: var(--success); opacity: 0.7;
}
.orchestrator-header {
    display: flex; align-items: center; gap: 16px;
}
.orchestrator-icon { font-size: 40px; }
.orchestrator-icon img { width: 128px; height: 128px; border-radius: 50%; object-fit: cover; box-shadow: 0 0 12px rgba(16,185,129,0.4); }
.orchestrator-info { flex: 1; }
.orchestrator-name { font-size: 22px; font-weight: 700; color: var(--text-primary); }
.orchestrator-role { font-size: 12px; color: var(--success); margin-top: 2px; }
.orchestrator-meta {
    display: flex; gap: 24px; margin-top: 14px; padding-top: 14px;
    border-top: 1px solid var(--border);
}
.orchestrator-meta-item { display: flex; flex-direction: column; gap: 2px; }
.orchestrator-meta-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
.orchestrator-meta-value { font-size: 13px; color: var(--text-primary); }

/* Memory agent (sub-orchestrator) */
.memory-connector {
    text-align: center; padding: 2px 0;
}
.memory-card {
    background: var(--bg-secondary);
    border: 1px solid var(--accent, #60a5fa);
    border-radius: var(--radius);
    padding: 14px 20px;
    max-width: 340px;
    margin: 0 auto 8px auto;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}
.memory-card:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(96,165,250,0.12); }
.memory-card::after {
    content: 'COMPRESSION';
    position: absolute; top: 6px; right: 10px;
    font-size: 8px; letter-spacing: 1.2px; color: var(--accent, #60a5fa); opacity: 0.7;
}
.memory-card-header { display: flex; align-items: center; gap: 12px; }
.memory-icon { font-size: 28px; }
.memory-name { font-size: 16px; font-weight: 600; color: var(--text-primary); }
.memory-role { font-size: 11px; color: var(--accent, #60a5fa); }
.memory-meta { display: flex; gap: 16px; margin-top: 10px; font-size: 11px; color: var(--text-secondary); }
.memory-model-select {
    background: var(--bg-tertiary); border: 1px solid var(--border);
    color: var(--text-primary); border-radius: 4px; padding: 3px 8px;
    font-size: 11px; cursor: pointer; margin-top: 8px; width: 100%;
}
.memory-model-select:focus { border-color: var(--accent, #60a5fa); outline: none; }

/* Category headers */
.category-header {
    font-size: 11px; text-transform: uppercase; letter-spacing: 1px;
    color: var(--text-muted); margin-bottom: 12px; padding-left: 4px;
}

/* Agent grid */
.agents-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 12px;
}

/* Agent cards (tier 1) */
.agent-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px 20px;
    cursor: pointer;
    transition: all 0.2s;
}
.agent-card:hover { border-color: var(--border-light); transform: translateY(-1px); }
.agent-card.inactive { opacity: 0.55; }

.agent-card-header {
    display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
}
.agent-icon { font-size: 24px; }
.agent-name { font-size: 15px; font-weight: 600; }
.agent-role { font-size: 11px; color: var(--text-muted); }

.agent-status-dot {
    width: 8px; height: 8px; border-radius: 50%;
    display: inline-block; margin-left: auto; flex-shrink: 0;
}
.agent-status-dot.active { background: var(--success); }
.agent-status-dot.inactive { background: var(--text-muted); }

.agent-meta-row {
    display: flex; gap: 16px; font-size: 11px; color: var(--text-secondary);
    margin-top: 8px;
}
.agent-meta-row span { display: flex; align-items: center; gap: 4px; }

.agent-model-select {
    background: var(--bg-tertiary); border: 1px solid var(--border);
    color: var(--text-primary); border-radius: 4px; padding: 3px 8px;
    font-size: 11px; cursor: pointer; margin-top: 8px; width: 100%;
}
.agent-model-select:focus { border-color: var(--accent, #60a5fa); outline: none; }

/* Workspace file dots */
.agent-files { display: flex; gap: 4px; margin-top: 10px; }
.file-dot {
    width: 6px; height: 6px; border-radius: 50%;
    background: var(--bg-tertiary); border: 1px solid var(--border);
}
.file-dot.exists { background: var(--success); border-color: var(--success); }

/* Modal */
.modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; align-items: center; justify-content: center; }
.modal.active { display: flex; }
.modal-content { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; max-width: 800px; width: 95%; max-height: 85vh; overflow-y: auto; }
.modal-wide { max-width: 900px; }
.modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border); }
.modal-title { font-size: 18px; font-weight: 600; }
.modal-close { background: none; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer; padding: 0 4px; }
.modal-close:hover { color: var(--text-primary); }
.modal-body { padding: 24px; }

.detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
.detail-item { display: flex; flex-direction: column; gap: 4px; }
.detail-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; }
.detail-value { font-size: 14px; color: var(--text-primary); }

.file-viewer { margin-top: 16px; }
.file-tabs { display: flex; gap: 4px; margin-bottom: 12px; flex-wrap: wrap; }
.file-tab {
    padding: 6px 12px; background: var(--bg-tertiary); border: 1px solid var(--border);
    border-radius: 6px 6px 0 0; color: var(--text-secondary); cursor: pointer;
    font-size: 12px; border-bottom: none;
}
.file-tab.active { background: var(--bg-secondary); color: var(--text-primary); border-color: var(--border-light); }
.file-tab.missing { opacity: 0.4; cursor: default; }
.file-content {
    background: var(--bg-primary); border: 1px solid var(--border); border-radius: 0 8px 8px 8px;
    padding: 16px; font-family: 'SF Mono', Monaco, Consolas, monospace; font-size: 12px;
    line-height: 1.6; color: var(--text-secondary); max-height: 400px; overflow-y: auto;
    white-space: pre-wrap; word-break: break-word;
}

.sessions-list { margin-top: 16px; }
.session-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 8px 12px; border-bottom: 1px solid var(--border); font-size: 13px;
}
.session-row:hover { background: var(--bg-hover); }
.session-key { font-family: 'SF Mono', Monaco, Consolas, monospace; font-size: 11px; color: var(--text-secondary); }
.session-age { color: var(--text-muted); font-size: 12px; }
</style>
{% endblock %}

{% block extra_js %}
<script>
let agentsData = [];

document.addEventListener('DOMContentLoaded', loadAgents);

async function loadAgents() {
    try {
        await loadAvailableModels();
        const res = await fetch('/api/agents');
        agentsData = await res.json();
        renderHierarchy(agentsData);
    } catch(e) {
        document.getElementById('orchestratorSection').innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted)">Failed to load agents</div>';
    }
}

const AGENT_ICONS = {
    'main': '/static/img/augmentor-icon.jpg',
    'dao': '/static/img/dao-icon.webp',
    'youtube': '/static/img/youtube-icon.webp',
    'website': '/static/img/website-icon.webp',
    'watchdog': '/static/img/watchdog-icon.webp',
    'doer': '/static/img/doer-icon.webp',
    'decoder': '/static/img/decoder-icon.webp',
};

function agentIconHtml(ag, size) {
    size = size || 28;
    const src = AGENT_ICONS[ag.agentId];
    if (src) return `<img src="${src}" alt="${ag.displayName}" style="width:${size}px;height:${size}px;border-radius:50%;object-fit:cover;">`;
    return ag.emoji;
}

// Loaded dynamically from user's configured providers
let KNOWN_MODELS = [];

async function loadAvailableModels() {
    try {
        const res = await fetch('/api/r-memory/available-models');
        const data = await res.json();
        KNOWN_MODELS = (data.models || []).map(m => ({value: m.model, label: m.label}));
    } catch (e) {
        console.warn('Failed to load available models, using defaults');
        KNOWN_MODELS = [{value: 'anthropic/claude-haiku-4-5', label: 'Claude Haiku 4.5 (default)'}];
    }
}

function renderHierarchy(agents) {
    const orchestrator = agents.find(a => a.tier === 0);
    const memoryAgent = agents.find(a => a.agentId === 'memory' && a.virtual);
    const direct = agents.filter(a => a.tier === 1 && a.category === 'direct');
    const background = agents.filter(a => a.tier === 1 && a.category === 'background');
    const support = agents.filter(a => a.tier === 1 && a.category === 'support');
    const other = agents.filter(a => a.tier === 1 && !['direct','background','support'].includes(a.category));

    // Orchestrator
    if (orchestrator) {
        const ag = orchestrator;
        const model = (typeof ag.mainModel === 'string' && ag.mainModel ? ag.mainModel : '-').split('/').pop();
        const hb = ag.heartbeat || {};
        const sess = ag.sessions || {};
        document.getElementById('orchestratorSection').innerHTML = `
            <div class="orchestrator-card" onclick="showAgentDetail('${ag.agentId}')">
                <div class="orchestrator-header">
                    <span class="orchestrator-icon">${agentIconHtml(ag, 128)}</span>
                    <div class="orchestrator-info">
                        <div class="orchestrator-name">${ag.displayName}</div>
                        <div class="orchestrator-role">${ag.role}</div>
                    </div>
                </div>
                <div class="orchestrator-meta">
                    <div class="orchestrator-meta-item">
                        <span class="orchestrator-meta-label">Model</span>
                        <span class="orchestrator-meta-value">${model}</span>
                    </div>
                    <div class="orchestrator-meta-item">
                        <span class="orchestrator-meta-label">Heartbeat</span>
                        <span class="orchestrator-meta-value">${hb.enabled ? hb.every : 'off'}</span>
                    </div>
                    <div class="orchestrator-meta-item">
                        <span class="orchestrator-meta-label">Sessions</span>
                        <span class="orchestrator-meta-value">${sess.count || 0}</span>
                    </div>
                    <div class="orchestrator-meta-item">
                        <span class="orchestrator-meta-label">Status</span>
                        <span class="orchestrator-meta-value" style="color:var(--success)">active</span>
                    </div>
                </div>
            </div>`;
        if (direct.length || background.length || support.length) {
            document.getElementById('connectorLine').style.display = 'block';
        }
    }

    // Memory agent (side by side with orchestrator) ‚Äî shows both sub-agents
    if (memoryAgent) {
        const subs = memoryAgent.subAgents || {};
        const comp = subs.compression || {};
        const narr = subs.narrative || {};

        // Build model selector options for compression
        const compCurrentModel = comp.model || memoryAgent.mainModel || 'anthropic/claude-haiku-4-5';
        const compOptions = KNOWN_MODELS.map(m =>
            `<option value="${m.value}" ${m.value === compCurrentModel ? 'selected' : ''}>${m.label}</option>`
        ).join('');
        const compInList = KNOWN_MODELS.some(m => m.value === compCurrentModel);
        const compCustomOpt = compInList ? '' : `<option value="${compCurrentModel}" selected>${compCurrentModel}</option>`;

        // Build model selector options for narrative
        const narrCurrentModel = narr.model || 'openai/gpt-4o';
        const narrOptions = KNOWN_MODELS.map(m =>
            `<option value="${m.value}" ${m.value === narrCurrentModel ? 'selected' : ''}>${m.label}</option>`
        ).join('');
        const narrInList = KNOWN_MODELS.some(m => m.value === narrCurrentModel);
        const narrCustomOpt = narrInList ? '' : `<option value="${narrCurrentModel}" selected>${narrCurrentModel}</option>`;

        const sec = document.getElementById('memoryAgentSection');
        sec.style.display = 'block';
        sec.innerHTML = `
            <div class="memory-card" style="min-width:320px;">
                <div class="memory-card-header">
                    <span class="memory-icon">${memoryAgent.emoji}</span>
                    <div>
                        <div class="memory-name" style="font-size:18px;">${memoryAgent.displayName}</div>
                        <div class="memory-role">${memoryAgent.role}</div>
                    </div>
                    <span class="agent-status-dot ${memoryAgent.status}" style="margin-left:auto;"></span>
                </div>
                <div style="display:flex; flex-direction:column; gap:10px; margin-top:12px;">
                    <div style="padding:10px 12px; background:var(--bg-primary); border-radius:8px; border:1px solid var(--border);">
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                            <span style="font-size:16px;">‚öôÔ∏è</span>
                            <span style="font-size:12px; font-weight:600; color:var(--text-primary);">${comp.label || 'Compression'}</span>
                            <span style="font-size:11px; color:var(--text-secondary); margin-left:auto;">${comp.calls ? comp.calls + ' calls' : ''}</span>
                        </div>
                        <select class="memory-model-select" onchange="updateCompressionModel(this.value)" title="Compression model" style="margin-top:0;">
                            ${compCustomOpt}${compOptions}
                        </select>
                    </div>
                    <div style="padding:10px 12px; background:var(--bg-primary); border-radius:8px; border:1px solid var(--border);">
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                            <span style="font-size:16px;">üìù</span>
                            <span style="font-size:12px; font-weight:600; color:var(--text-primary);">${narr.label || 'Narrative Tracker'}</span>
                            <span style="font-size:11px; color:var(--text-secondary); margin-left:auto;">${narr.calls ? narr.calls + ' calls' : ''}</span>
                        </div>
                        <select class="memory-model-select" onchange="updateNarrativeModel(this.value)" title="Narrative model" style="margin-top:0;">
                            ${narrCustomOpt}${narrOptions}
                        </select>
                    </div>
                </div>
            </div>`;
    }

    // Render category sections
    function renderCategory(containerId, label, agents) {
        if (!agents.length) return;
        const el = document.getElementById(containerId);
        el.innerHTML = `
            <div class="category-header">${label}</div>
            <div class="agents-grid">
                ${agents.map(ag => renderAgentCard(ag)).join('')}
            </div>`;
    }

    renderCategory('directAgents', 'üéØ Direct Communication Agents', direct);
    renderCategory('backgroundAgents', '‚öôÔ∏è Background Agents', background);
    renderCategory('supportAgents', 'üõ°Ô∏è Support & Monitoring', support);
    if (other.length) {
        let el = document.getElementById('otherAgents');
        if (!el) {
            el = document.createElement('div');
            el.style.marginTop = '24px';
            el.id = 'otherAgents';
            document.getElementById('supportAgents').after(el);
        }
        renderCategory('otherAgents', 'üì¶ Other', other);
    } else {
        const existing = document.getElementById('otherAgents');
        if (existing) existing.remove();
    }
}

function renderAgentCard(ag) {
    const model = ag.mainModel || '';
    const modelShort = model ? model.split('/').pop() : '-';
    const sess = ag.sessions || {};
    const files = ag.workspaceFiles || {};
    const fileNames = ['SOUL.md', 'IDENTITY.md', 'AGENTS.md', 'USER.md', 'MEMORY.md'];
    const recent = (sess.recent || [])[0];
    const recentAge = recent ? formatAge(recent.age) : 'none';

    const modelOptions = KNOWN_MODELS.map(m =>
        `<option value="${m.value}" ${m.value === model ? 'selected' : ''}>${m.label}</option>`
    ).join('');
    const inList = KNOWN_MODELS.some(m => m.value === model);
    const customOpt = (!inList && model) ? `<option value="${model}" selected>${model}</option>` : '';

    return `
    <div class="agent-card ${ag.status === 'inactive' ? 'inactive' : ''}">
        <div class="agent-card-header" onclick="showAgentDetail('${ag.agentId}')">
            <span class="agent-icon">${agentIconHtml(ag, 32)}</span>
            <div>
                <div class="agent-name">${ag.displayName}</div>
                <div class="agent-role">${ag.role}</div>
            </div>
            <span class="agent-status-dot ${ag.status}"></span>
        </div>
        <div class="agent-meta-row">
            <span>üìä ${sess.count || 0} sessions</span>
            <span>üïê ${recentAge}</span>
        </div>
        <select class="agent-model-select" onchange="updateAgentModel('${ag.agentId}', this.value)" onclick="event.stopPropagation()" title="Agent model">
            ${customOpt}${modelOptions}
        </select>
        <div class="agent-files" title="${fileNames.map(f => f + (files[f] ? ' ‚úì' : ' ‚úó')).join(', ')}">
            ${fileNames.map(f => `<span class="file-dot ${files[f] ? 'exists' : ''}" title="${f}"></span>`).join('')}
        </div>
    </div>`;
}

async function showAgentDetail(agentId) {
    const ag = agentsData.find(a => a.agentId === agentId);
    if (!ag) return;

    const modal = document.getElementById('agentModal');
    const body = document.getElementById('modalBody');
    document.getElementById('modalTitle').textContent = `${ag.emoji} ${ag.displayName}`;

    const hb = ag.heartbeat || {};
    const sess = ag.sessions || {};
    const files = ag.workspaceFiles || {};
    const fileNames = Object.keys(files);

    body.innerHTML = `
        <div class="detail-grid">
            <div class="detail-item">
                <span class="detail-label">Agent ID</span>
                <span class="detail-value" style="font-family:monospace;">${agentId}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Role</span>
                <span class="detail-value">${ag.role || '-'}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Category</span>
                <span class="detail-value">${ag.category || '-'}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Tier</span>
                <span class="detail-value">${ag.tier === 0 ? 'Orchestrator' : 'Agent'}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Model</span>
                <span class="detail-value">${(typeof ag.mainModel === 'string' && ag.mainModel ? ag.mainModel : '-').split('/').pop()}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Status</span>
                <span class="detail-value" style="color:${ag.status==='active'?'var(--success)':'var(--text-muted)'}">${ag.status}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Heartbeat</span>
                <span class="detail-value">${hb.enabled ? hb.every + ' (' + (hb.model||'').split('/').pop() + ')' : 'Disabled'}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Sessions</span>
                <span class="detail-value">${sess.count || 0}</span>
            </div>
        </div>

        ${fileNames.length ? `
        <h3 style="margin-bottom: 8px; font-size: 14px;">Workspace Files</h3>
        <div class="file-viewer">
            <div class="file-tabs">
                ${fileNames.map((f, i) => `<div class="file-tab ${i===0?'active':''}" onclick="switchFileTab(this, '${f}')">${f}</div>`).join('')}
            </div>
            <div class="file-content" id="fileContent">${escapeHtml(files[fileNames[0]] || 'empty')}</div>
        </div>` : '<p style="color:var(--text-muted)">No workspace files found</p>'}

        ${(sess.recent || []).length ? `
        <h3 style="margin: 24px 0 8px; font-size: 14px;">Recent Sessions</h3>
        <div class="sessions-list">
            ${(sess.recent || []).map(s => `
                <div class="session-row">
                    <span class="session-key">${s.key}</span>
                    <span class="session-age">${formatAge(s.age)}</span>
                </div>
            `).join('')}
        </div>` : ''}
    `;

    window._agentFiles = files;
    modal.classList.add('active');
}

function switchFileTab(el, filename) {
    document.querySelectorAll('.file-tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    document.getElementById('fileContent').textContent = window._agentFiles[filename] || 'empty';
}

function closeModal() {
    document.getElementById('agentModal').classList.remove('active');
}
document.getElementById('agentModal').addEventListener('click', function(e) {
    if (e.target === this) closeModal();
});

function escapeHtml(text) {
    const d = document.createElement('div');
    d.textContent = text;
    return d.innerHTML;
}

async function updateCompressionModel(model) {
    try {
        const res = await fetch('/api/r-memory/config', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({compressionModel: model})
        });
        const data = await res.json();
        if (data.ok) {
            const meta = document.querySelector('.memory-meta span');
            if (meta) meta.textContent = 'Model: ' + model.split('/').pop();
            showToast('R-Memory model ‚Üí ' + model.split('/').pop());
            showRestartBanner();
        } else {
            showToast('Failed to update R-Memory model', 'error');
        }
    } catch(e) {
        console.error('Failed to update compression model', e);
        showToast('Failed to update compression model', 'error');
    }
}

async function updateNarrativeModel(model) {
    try {
        const res = await fetch('/api/r-memory/narrative-model', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({model: model})
        });
        const data = await res.json();
        if (data.ok) {
            showToast('Narrative model ‚Üí ' + model.split('/').pop());
            showRestartBanner();
        } else {
            showToast('Failed to update narrative model', 'error');
        }
    } catch(e) {
        console.error('Failed to update narrative model', e);
        showToast('Failed to update narrative model', 'error');
    }
}

async function updateAgentModel(agentId, model) {
    try {
        const res = await fetch('/api/agents/' + agentId + '/model', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({model: model})
        });
        const data = await res.json();
        if (data.ok) {
            const ag = agentsData.find(a => a.agentId === agentId);
            if (ag) ag.mainModel = model;
            showToast(`${agentId} model ‚Üí ${model.split('/').pop()}`);
            showRestartBanner();
        } else {
            showToast(data.error || 'Failed to update model', 'error');
        }
    } catch(e) {
        console.error('Failed to update agent model', e);
        showToast('Failed to update agent model', 'error');
    }
}

function showRestartBanner() {
    if (document.getElementById('gatewayRestartBanner')) return;
    const b = document.createElement('div');
    b.id = 'gatewayRestartBanner';
    b.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:9999;background:#f59e0b;color:#000;padding:10px 20px;display:flex;align-items:center;justify-content:center;gap:12px;font-size:14px;font-weight:500;box-shadow:0 2px 8px rgba(0,0,0,.3)';
    b.innerHTML = '‚ö†Ô∏è Gateway restart required for model changes to take effect. <button onclick="restartGateway()" style="background:#000;color:#f59e0b;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-weight:600">Restart Gateway</button> <button onclick="this.parentElement.remove()" style="background:transparent;border:1px solid #000;color:#000;padding:5px 12px;border-radius:6px;cursor:pointer">Dismiss</button>';
    document.body.prepend(b);
}

async function restartGateway() {
    const btn = document.querySelector('#gatewayRestartBanner button');
    if (btn) { btn.disabled = true; btn.textContent = 'Restarting...'; }
    try {
        const res = await fetch('/api/gateway/restart', {method: 'POST'});
        const data = await res.json();
        if (data.ok) {
            showToast('Gateway restarting...');
            const banner = document.getElementById('gatewayRestartBanner');
            if (banner) banner.remove();
        } else {
            showToast(data.error || 'Restart failed', 'error');
            if (btn) { btn.disabled = false; btn.textContent = 'Restart Gateway'; }
        }
    } catch(e) {
        showToast('Restart failed: ' + e.message, 'error');
        if (btn) { btn.disabled = false; btn.textContent = 'Restart Gateway'; }
    }
}

function showToast(msg, type) {
    const t = document.createElement('div');
    t.style.cssText = 'position:fixed;bottom:20px;right:20px;padding:12px 20px;border-radius:8px;z-index:999;font-size:13px;color:#fff;background:' + (type==='error'?'#ef4444':'#22c55e');
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 3000);
}

function formatAge(ms) {
    if (!ms && ms !== 0) return '-';
    if (ms < 60000) return Math.round(ms/1000) + 's ago';
    if (ms < 3600000) return Math.round(ms/60000) + 'm ago';
    if (ms < 86400000) return Math.round(ms/3600000) + 'h ago';
    return Math.round(ms/86400000) + 'd ago';
}
</script>
{% endblock %}